(function(){function r(a){return a&&a.Object===Object?a:null}function F(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function c(a){var M={};this.settings=a;this.on=function(a,c){M[a]=c};this.emit=function(a){var c=M[a];c&&c.apply(null,Array.prototype.slice.call(arguments,1))};this.filename=a.name||F();this.mimeType=this.extension=""}function e(a){c.call(this,a);this.extension=".tar";this.mimeType="application/x-tar";
this.fileExtension="";this.tape=null;this.count=0}function G(a){e.call(this,a);this.type="image/png";this.fileExtension=".png"}function H(a){e.call(this,a);this.type="image/jpeg";this.fileExtension=".jpg";this.quality=a.quality/100||0.8}function w(a){"image/webp"!==document.createElement("canvas").toDataURL("image/webp").substr(5,10)&&console.log("WebP not supported - try another export format");c.call(this,a);a.quality=a.quality/100||0.8;this.extension=".webm";this.mimeType="video/webm";this.baseFilename=
this.filename;this.frames=[];this.part=1}function x(a){c.call(this,a);a.quality=a.quality/100||0.8;this.encoder=new FFMpegServer.Video(a);this.encoder.on("process",function(){this.emit("process")}.bind(this));this.encoder.on("finished",function(a,c){var e=this.callback;e&&(this.callback=void 0,e(a,c))}.bind(this));this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("error",function(a){alert(JSON.stringify(a,null,2))}.bind(this))}
function D(a){c.call(this,a);this.framerate=this.settings.framerate;this.type="video/webm";this.extension=".webm";this.mediaRecorder=this.stream=null;this.chunks=[]}function E(a){c.call(this,a);a.quality=31-(30*a.quality/100||10);a.workers=a.workers||4;this.extension=".gif";this.mimeType="image/gif";this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sizeSet=!1;this.encoder=new GIF({workers:a.workers,quality:a.quality,workerScript:a.workersPath+"gif.worker.js"});
this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("finished",function(a){var c=this.callback;c&&(this.callback=void 0,c(a))}.bind(this))}function k(a){function c(){function a(){this._hooked||(this._hooked=!0,this._hookedTime=this.currentTime||0,this.pause(),N.push(this));return this._hookedTime+b.startTime}n("Capturer start");u=window.Date.now();o=u+b.startTime;I=window.performance.now();v=I+b.startTime;window.Date.prototype.getTime=
function(){return o};window.Date.now=function(){return o};window.setTimeout=function(a,m){var b={callback:a,time:m,triggerTime:o+m};q.push(b);n("Timeout set to "+b.time);return b};window.clearTimeout=function(a){for(var m=0;m<q.length;m++)q[m]==a&&(q.splice(m,1),n("Timeout cleared"))};window.setInterval=function(a,m){var b={callback:a,time:m,triggerTime:o+m};s.push(b);n("Interval set to "+b.time);return b};window.clearInterval=function(){n("clear Interval");return null};window.requestAnimationFrame=
function(a){J.push(a)};window.performance.now=function(){return v};Object.defineProperty(HTMLVideoElement.prototype,"currentTime",{get:a});Object.defineProperty(HTMLAudioElement.prototype,"currentTime",{get:a})}function e(){K=!1;i.stop();n("Capturer stop");window.setTimeout=A;window.setInterval=F;window.clearTimeout=L;window.requestAnimationFrame=R;window.Date.prototype.getTime=S;window.Date.now=T;window.performance.now=U}function g(){A(O,0,void 0)}function k(){var a=p/b.framerate;if(b.frameLimit&&
p>=b.frameLimit||b.timeLimit&&a>=b.timeLimit)e(),h();var d=new Date(null);d.setSeconds(a);l.textContent=2<b.motionBlurFrames?"CCapture "+b.format+" | "+p+" frames ("+y+" inter) | "+d.toISOString().substr(11,8):"CCapture "+b.format+" | "+p+" frames | "+d.toISOString().substr(11,8)}function O(){var a=(p+y/b.motionBlurFrames)*(1E3/b.framerate);o=u+a;v=I+a;N.forEach(function(b){b._hookedTime=a/1E3});k();n("Frame: "+p+" "+y);for(var d=0;d<q.length;d++)o>=q[d].triggerTime&&(A(q[d].callback,0,void 0),q.splice(d,
1));for(d=0;d<s.length;d++)o>=s[d].triggerTime&&(A(s[d].callback,0,void 0),s[d].triggerTime+=s[d].time);J.forEach(function(a){A(a,0,o-V)});J=[]}function h(a){a||(a=function(a){download(a,i.filename+i.extension,i.mimeType);return!1});i.save(a)}function n(a){r&&console.log(a)}function t(a){var b=C[a];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}var b=a||{},r,o,u,v,I,i,q=[],s=[],p=0,y=0,J=[],K=!1,C={};b.framerate=b.framerate||60;b.motionBlurFrames=2*(b.motionBlurFrames||1);r=b.verbose||!1;
b.step=1E3/b.framerate;b.timeLimit=b.timeLimit||0;b.frameLimit=b.frameLimit||0;b.startTime=b.startTime||0;var l=document.createElement("div");l.style.position="absolute";l.style.left=l.style.top=0;l.style.backgroundColor="black";l.style.fontFamily="monospace";l.style.fontSize="11px";l.style.padding="5px";l.style.color="red";l.style.zIndex=1E5;b.display&&document.body.appendChild(l);var j=document.createElement("canvas"),B=j.getContext("2d"),f,z;n("Step is set to "+b.step+"ms");var a={gif:E,webm:w,
ffmpegserver:x,png:G,jpg:H,"webm-mediarecorder":D},P=a[b.format];if(!P)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(a).join(", ");i=new P(b);i.step=g;i.on("process",O);i.on("progress",function(a){t("progress",a)});!1=="performance"in window&&(window.performance={});Date.now=Date.now||function(){return(new Date).getTime()};if(!1=="now"in window.performance){var Q=Date.now();performance.timing&&performance.timing.navigationStart&&(Q=performance.timing.navigationStart);window.performance.now=
function(){return Date.now()-Q}}var A=window.setTimeout,F=window.setInterval,L=window.clearTimeout,R=window.requestAnimationFrame,T=window.Date.now,U=window.performance.now,S=window.Date.prototype.getTime,N=[];return{start:function(){c();i.start();K=!0},capture:function(a){if(K)if(2<b.motionBlurFrames){if(j.width!==a.width||j.height!==a.height)j.width=a.width,j.height=a.height,f=new Uint16Array(4*j.height*j.width),B.fillStyle="#0",B.fillRect(0,0,j.width,j.height);B.drawImage(a,0,0);z=B.getImageData(0,
0,j.width,j.height);for(a=0;a<f.length;a+=4)f[a]+=z.data[a],f[a+1]+=z.data[a+1],f[a+2]+=z.data[a+2];y++;if(y>=0.5*b.motionBlurFrames){for(var a=z.data,d=0;d<f.length;d+=4)a[d]=2*f[d]/b.motionBlurFrames,a[d+1]=2*f[d+1]/b.motionBlurFrames,a[d+2]=2*f[d+2]/b.motionBlurFrames;B.putImageData(z,0,0);i.add(j);p++;y=0;n("Full MB Frame! "+p+" "+o);for(d=0;d<f.length;d+=4)f[d]=0,f[d+1]=0,f[d+2]=0;gc()}else g()}else i.add(a),p++,n("Full Frame! "+p)},stop:e,save:h,on:function(a,b){C[a]=b}}}var g={"function":!0,
object:!0},h=g[typeof exports]&&exports&&!exports.nodeType?exports:void 0,t=g[typeof module]&&module&&!module.nodeType?module:void 0,L=t&&t.exports===h?h:void 0,u=r(h&&t&&"object"==typeof global&&global),C=r(g[typeof self]&&self),v=r(g[typeof window]&&window),g=r(g[typeof this]&&this),u=u||v!==(g&&g.window)&&v||C||g||Function("return this")();"gc"in window||(window.gc=function(){});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,c,e){for(var e=
atob(this.toDataURL(c,e).split(",")[1]),g=e.length,k=new Uint8Array(g),h=0;h<g;h++)k[h]=e.charCodeAt(h);a(new Blob([k],{type:c||"image/png"}))}});(function(){!1=="performance"in window&&(window.performance={});Date.now=Date.now||function(){return(new Date).getTime()};if(!1=="now"in window.performance){var a=Date.now();performance.timing&&performance.timing.navigationStart&&(a=performance.timing.navigationStart);window.performance.now=function(){return Date.now()-a}}})();var V=window.Date.now();c.prototype.start=
function(){};c.prototype.stop=function(){};c.prototype.add=function(){};c.prototype.save=function(){};c.prototype.dispose=function(){};c.prototype.safeToProceed=function(){return!0};c.prototype.step=function(){console.log("Step not set!")};e.prototype=Object.create(c.prototype);e.prototype.start=function(){this.dispose()};e.prototype.add=function(a){var c=new FileReader;c.onload=function(){this.tape.append(("0000000"+this.count).slice(-7)+this.fileExtension,new Uint8Array(c.result));this.count++;
this.step()}.bind(this);c.readAsArrayBuffer(a)};e.prototype.save=function(a){a(this.tape.save())};e.prototype.dispose=function(){this.tape=new Tar;this.count=0};G.prototype=Object.create(e.prototype);G.prototype.add=function(a){a.toBlob(function(a){e.prototype.add.call(this,a)}.bind(this),this.type)};H.prototype=Object.create(e.prototype);H.prototype.add=function(a){a.toBlob(function(a){e.prototype.add.call(this,a)}.bind(this),this.type,this.quality)};w.prototype=Object.create(c.prototype);w.prototype.start=
function(){this.dispose()};w.prototype.add=function(a){this.frames.push(a.toDataURL("image/webp",this.quality));0<this.settings.autoSaveTime&&this.frames.length/this.settings.framerate>=this.settings.autoSaveTime?this.save(function(a){this.filename=this.baseFilename+"-part-"+("0000000"+this.part).slice(-7);download(a,this.filename+this.extension,this.mimeType);this.dispose();this.part++;this.filename=this.baseFilename+"-part-"+("0000000"+this.part).slice(-7);this.step()}.bind(this)):this.step()};
w.prototype.save=function(a){if(this.frames.length){var c=Whammy.fromImageArray(this.frames,this.settings.framerate),c=new Blob([c],{type:"octet/stream"});a(c)}};w.prototype.dispose=function(){this.frames=[]};x.prototype=Object.create(c.prototype);x.prototype.start=function(){this.encoder.start(this.settings)};x.prototype.add=function(a){this.encoder.add(a)};x.prototype.save=function(a){this.callback=a;this.encoder.end()};x.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};D.prototype=
Object.create(c.prototype);D.prototype.add=function(a){this.stream||(this.stream=a.captureStream(this.framerate),this.mediaRecorder=new MediaRecorder(this.stream),this.mediaRecorder.start(),this.mediaRecorder.ondataavailable=function(a){this.chunks.push(a.data)}.bind(this));this.step()};D.prototype.save=function(a){this.mediaRecorder.onstop=function(){var c=new Blob(this.chunks,{type:"video/webm"});this.chunks=[];a(c)}.bind(this);this.mediaRecorder.stop()};E.prototype=Object.create(c.prototype);E.prototype.add=
function(a){this.sizeSet||(this.encoder.setOption("width",a.width),this.encoder.setOption("height",a.height),this.sizeSet=!0);this.canvas.width=a.width;this.canvas.height=a.height;this.ctx.drawImage(a,0,0);this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step});this.step()};E.prototype.save=function(a){this.callback=a;this.encoder.render()};(v||C||{}).CCapture=k;"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return k}):h&&t?(L&&((t.exports=k).CCapture=
k),h.CCapture=k):u.CCapture=k})();
